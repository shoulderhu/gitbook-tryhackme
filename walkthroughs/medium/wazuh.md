# Wazuh

{% embed url="https://tryhackme.com/room/wazuhct" %}
https://tryhackme.com/room/wazuhct
{% endembed %}

## Task 1 Introduction

#### When was Wazuh released?

{% hint style="success" %}
`2015`
{% endhint %}

#### What is the term that Wazuh calls a device that is being monitored for suspicious activity and potential security threats?

{% hint style="success" %}
`agent`
{% endhint %}

#### Lastly, what is the term for a device that is responsible for managing these devices?

{% hint style="success" %}
`manager`
{% endhint %}

## Task 3 Wazuh Agents

#### Navigate to the "Agents" tab by pressing **Wazuh** -> **Agents**

![](<../../.gitbook/assets/Screenshot from 2022-05-05 06-02-52.png>)

#### How many agents does this Wazuh management server manage?

{% hint style="success" %}
`2`
{% endhint %}

#### What are the status of the agents managed by this Wazuh management server?

{% hint style="success" %}
`disconnected`
{% endhint %}

## Task 4 Wazuh Vulnerability Assessment & Security Events

#### Navigate to the Agents tab by pressing **Wazuh** -> **Agents** like so

#### Select the agent named "**AGENT-001**"

![](<../../.gitbook/assets/Screenshot from 2022-05-05 06-02-09.png>)

#### How many "Security Event" alerts have been generated by the agent "AGENT-001"?

{% hint style="success" %}
`196`
{% endhint %}

## Task 5 Wazuh Policy Auditing

#### Navigate to the "Modules" tab by pressing **Wazuh** -> **Modules** and open the "Policy Management" module like so:

![](<../../.gitbook/assets/Screenshot from 2022-05-05 06-09-01.png>)

## Task 6 Monitoring Logons with Wazuh

For reference, the alert is stored in a specific file on the Wazuh management server: `/var/ossec/logs/alerts/alerts.log`

#### Navigate to the "Management" tab by pressing Wazuh -> **Management** and open the "Rules" module like so:

![](<../../.gitbook/assets/Screenshot from 2022-05-05 06-18-28.png>)

## Task 7 Collecting Windows Logs with Wazuh

#### Sysmon

```bash
Sysmon64.exe -accepteula -i detect_powershell.xml
```

#### Windows (Agent) - C:\Program Files (x86)\ossec-agent\ossec.conf

```bash
<localfile>
<location>Microsoft-Windows-Sysmon/Operational</location>
<log_format>eventchannel</log_format>
</localfile>
```

#### Linux (Manager) - /var/ossec/etc/rules/local\_rules.xml

```bash
<group name="sysmon,">
 <rule id="255000" level="12">
 <if_group>sysmon_event1</if_group>
 <field name="sysmon.image">\\powershell.exe||\\.ps1||\\.ps2</field>
 <description>Sysmon - Event 1: Bad exe: $(sysmon.image)</description>
 <group>sysmon_event1,powershell_execution,</group>
 </rule>
</group>
```

#### What is the name of the tool that we can use to monitor system events?

{% hint style="success" %}
`sysmon`
{% endhint %}

#### What standard application on Windows do these system events get recorded to?

{% hint style="success" %}
`Event Viewer`
{% endhint %}

## Task 8 Collecting Linux Logs with Wazuh

#### Linux (Agent) - /var/ossec/etc/ossec.conf

```bash
<!-- Apache2 Log Analysis -->
  <localfile>
    <location>/var/log/example.log</location>
    <log_format>syslog</log_format>
  </localfile>
```

#### What is the full file path to the rules located on a Wazuh management server?

{% hint style="success" %}
`/var/ossec/ruleset/rules`
{% endhint %}

## Task 9 Auditing Commands on Linux with Wazuh

#### Linux (Agent)

```bash
sudo apt-get install auditd audispd-plugins
sudo systemctl enable --now auditd.service
```

```bash
echo '-a exit,always -F arch=64 -F euid=0 -S execve -k audit-wazuh-c' | sudo tee -a /etc/audit/rules.d/audit.rules
sudo auditctl -R /etc/audit/rules.d/audit.rules 
```

#### Linux (Manager) - /var/ossec/etc/ossec.conf

```bash
<localfile>
    <location>/var/log/audit/audit.log</location>
    <log_format>audit</log_format>
</localfile>
```

#### What application do we use on Linux to monitor events such as command execution?

{% hint style="success" %}
`Auditd`
{% endhint %}

#### What is the full path & filename for where the aforementioned application stores rules?

{% hint style="success" %}
`/etc/audit/rules.d/audit.rules`
{% endhint %}

## Task 10 Wazuh API

#### Wazuh Token

```bash
TOKEN=$(curl -u : -k -X GET "https://WAZUH_MANAGEMENT_SERVER_IP:55000/security/user/authenticate?raw=true")
```

#### Example

```bash
curl -k -X GET "https://10.10.221.14:55000/manager/status?pretty=true" -H "Authorization: Bearer $TOKEN"
curl -k -X GET "https://10.10.221.14:55000/manager/configuration?pretty=trueÂ§ion=global" -H "Authorization: Bearer $TOKEN"
curl -k -X GET "https://10.10.221.14:55000/agents?pretty=true&offset=1&limit=2&select=status%2Cid%2Cmanager%2Cname%2Cnode_name%2Cversion&status=active" -H "Authorization: Bearer $TOKEN"
```

#### What is the name of the standard Linux tool that we can use to make requests to the Wazuh management server?

{% hint style="success" %}
`curl`
{% endhint %}

#### What HTTP method would we use to retrieve information for a Wazuh management server API?

{% hint style="success" %}
`GET`
{% endhint %}

#### What HTTP method would we use to perform an action on a Wazuh management server API?

{% hint style="success" %}
`PUT`
{% endhint %}

#### Navigate to Wazuh's API console.

![](<../../.gitbook/assets/Screenshot from 2022-05-05 06-48-33.png>)

#### Use the API console to find the Wazuh server's version.

{% hint style="success" %}
`v4.2.5`
{% endhint %}

## Task 11 Generating Reports with Wazuh

#### Use Wazuh's "Report" feature to generate a report of an agent.

#### Navigate to the [Wazuh "Report" dashboard](https://10.10.221.14/app/wazuh#/manager/?tab=reporting)

![](<../../.gitbook/assets/Screenshot from 2022-05-05 06-51-45.png>)

#### Analyse the report. What is the name of the agent that has generated the most alerts?

![](<../../.gitbook/assets/Screenshot from 2022-05-05 07-00-40.png>) ![](<../../.gitbook/assets/Screenshot from 2022-05-05 07-00-57.png>)

{% hint style="success" %}
`agent-001`
{% endhint %}

## Task 12 Loading Sample Data

#### I've imported the sample data!

![](<../../.gitbook/assets/Screenshot from 2022-05-05 07-03-54.png>)

#### I have played around with the sample data.

![](<../../.gitbook/assets/Screenshot from 2022-05-05 07-04-50.png>)
